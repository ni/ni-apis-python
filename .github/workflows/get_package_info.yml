name: Get package info

on:
  workflow_call:
    inputs:
      package-name:
        description: 'The name of the package to check.'
        default: ''
        required: true
        type: string
    outputs:
      proto-basepath:
        description: 'Base path for proto files.'
        value: ${{ jobs.get_package_info.outputs.proto-basepath }}
      proto-subpath:
        description: 'Subpath for proto files.'
        value: ${{ jobs.get_package_info.outputs.proto-subpath }}
      proto-include-path:
        description: 'Include path for proto files.'
        value: ${{ jobs.get_package_info.outputs.proto-include-path }}
      output-format:
        description: 'Output format.'
        value: ${{ jobs.get_package_info.outputs.output-format }}
      install-drivers:
        description: 'Whether to install drivers extra'
        value: ${{ jobs.get_package_info.outputs.install-drivers }}

jobs:
  get_package_info:
    name: Get package info for ${{ inputs.package-name }}
    runs-on: ubuntu-latest
    outputs:
      proto-basepath: ${{ steps.parse_json.outputs.proto-basepath }}
      proto-subpath: ${{ steps.parse_json.outputs.proto-subpath }}
      proto-include-path: ${{ steps.parse_json.outputs.proto-include-path }}
      output-format: ${{ steps.parse_json.outputs.output-format }}
      install-drivers: ${{ steps.parse_json.outputs.install-drivers }}
    steps:
      - name: Check out repo
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Get package info from JSON
        id: parse_json
        # NOTE: jq only supports standard JSON, not JSONC or JSON5
        run: |
          info=$(jq -c --arg name "${{ inputs.package-name }}" '.[$name]' "./packages.json")
          if [ "$info" = "null" ]; then
            echo "Error: Package '${{ inputs.package-name }}' not found in packages.json." >&2
            exit 1
          fi
          echo "Package info: $info"
          echo "proto-basepath=$(echo $info | jq -r '."proto-basepath"')" >> $GITHUB_OUTPUT
          echo "proto-subpath=$(echo $info | jq -r '."proto-subpath"')" >> $GITHUB_OUTPUT
          echo "proto-include-path=$(echo $info | jq -r '."proto-include-path"')" >> $GITHUB_OUTPUT
          echo "output-format=$(echo $info | jq -r '."output-format"')" >> $GITHUB_OUTPUT
          echo "install-drivers=$(echo $info | jq -r '."install-drivers"')" >> $GITHUB_OUTPUT